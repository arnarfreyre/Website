<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algarve Trip Planner - Plan Your Perfect Portugal Vacation</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --ocean-blue: #0077be;
            --ocean-light: #00a8cc;
            --sand-beige: #f5e6d3;
            --coral-accent: #e63946;
            --deep-blue: #1d3557;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --success-green: #10b981;
            --warning-yellow: #f59e0b;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--gray-800);
            overflow: hidden;
            height: 100vh;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }
        
        /* Header */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--white);
            border-bottom: 1px solid var(--gray-200);
            box-shadow: var(--shadow-sm);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 24px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--deep-blue);
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--ocean-blue), var(--ocean-light));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .search-container {
            flex: 1;
            max-width: 400px;
            margin: 0 40px;
        }
        
        .search-box {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: var(--gray-50);
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--ocean-blue);
            background: var(--white);
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }
        
        .view-toggles {
            display: flex;
            gap: 8px;
            background: var(--gray-100);
            padding: 4px;
            border-radius: 8px;
        }
        
        .view-toggle {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--gray-600);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .view-toggle.active {
            background: var(--white);
            color: var(--ocean-blue);
            box-shadow: var(--shadow-sm);
        }
        
        /* Sidebar */
        .sidebar {
            width: 400px;
            background: var(--gray-50);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 500;
            margin-top: 70px;
            border-right: 1px solid var(--gray-200);
        }
        
        .filters-section {
            background: var(--white);
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .filter-group {
            margin-bottom: 20px;
        }
        
        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 12px;
            display: block;
        }
        
        .rating-filter {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .rating-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--gray-200);
            outline: none;
        }
        
        .rating-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--ocean-blue);
            cursor: pointer;
            box-shadow: var(--shadow);
        }
        
        .rating-display {
            min-width: 80px;
            text-align: center;
            font-size: 14px;
            color: var(--gray-600);
        }
        
        .price-filters {
            display: flex;
            gap: 8px;
        }
        
        .price-filter {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--gray-200);
            background: var(--white);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        
        .price-filter.active {
            border-color: var(--ocean-blue);
            background: var(--ocean-blue);
            color: var(--white);
        }
        
        .amenities-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .amenity-filter {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border: 2px solid var(--gray-200);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            text-align: center;
        }
        
        .amenity-filter.active {
            border-color: var(--ocean-blue);
            background: var(--ocean-light);
            color: var(--white);
        }
        
        .filter-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--ocean-blue);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: var(--deep-blue);
        }
        
        .btn-secondary {
            background: var(--white);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }
        
        .btn-secondary:hover {
            background: var(--gray-50);
        }
        
        /* Hotel List */
        .hotels-section {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .results-count {
            font-size: 14px;
            color: var(--gray-600);
        }
        
        .sort-dropdown {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            background: var(--white);
            font-size: 14px;
            cursor: pointer;
        }
        
        .hotel-card {
            background: var(--white);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            gap: 16px;
            position: relative;
        }
        
        .hotel-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .hotel-card.selected {
            border: 2px solid var(--ocean-blue);
        }
        
        .hotel-image {
            width: 120px;
            height: 100px;
            border-radius: 8px;
            object-fit: cover;
            background: linear-gradient(135deg, var(--ocean-light), var(--ocean-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
        }
        
        .hotel-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .hotel-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }
        
        .hotel-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 4px;
        }
        
        .hotel-rating {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: var(--gray-600);
        }
        
        .stars {
            color: #fbbf24;
        }
        
        .hotel-price {
            font-size: 20px;
            font-weight: 700;
            color: var(--ocean-blue);
        }
        
        .hotel-details {
            font-size: 14px;
            color: var(--gray-600);
        }
        
        .hotel-amenities {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .amenity {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--gray-600);
        }
        
        .hotel-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .hotel-action {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            background: var(--white);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .hotel-action:hover {
            background: var(--gray-50);
            border-color: var(--ocean-blue);
            color: var(--ocean-blue);
        }
        
        /* Map */
        .map-container {
            flex: 1;
            position: relative;
            margin-top: 70px;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .map-control {
            background: var(--white);
            border: none;
            border-radius: 8px;
            padding: 12px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }
        
        .map-control:hover {
            background: var(--gray-50);
            transform: scale(1.05);
        }
        
        /* Loading and Error States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--ocean-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background: var(--coral-accent);
            color: var(--white);
            padding: 16px 24px;
            border-radius: 8px;
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            box-shadow: var(--shadow-lg);
            display: none;
        }
        
        /* Mobile Bottom Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 1px solid var(--gray-200);
            height: 60px;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .mobile-nav-items {
            display: flex;
            height: 100%;
        }
        
        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border: none;
            background: none;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--gray-500);
            font-size: 12px;
        }
        
        .mobile-nav-item.active {
            color: var(--ocean-blue);
        }
        
        .mobile-nav-item:active {
            background: var(--gray-50);
        }
        
        .mobile-nav-icon {
            font-size: 20px;
        }
        
        /* Mobile Styles */
        @media (max-width: 768px) {
            .header {
                padding: 0 16px;
            }
            
            .search-container {
                margin: 0 20px;
            }
            
            .view-toggles {
                display: none;
            }
            
            .mobile-nav {
                display: block;
            }
            
            .trip-planning-bar {
                flex-direction: column;
                height: auto;
                padding: 12px;
                gap: 12px;
            }
            
            .trip-info {
                width: 100%;
                justify-content: space-between;
            }
            
            .trip-summary {
                width: 100%;
                margin-left: 0;
                flex-direction: column;
                gap: 12px;
            }
            
            .trip-actions {
                width: 100%;
            }
            
            .trip-btn {
                flex: 1;
            }
            
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                height: 50vh;
                margin-top: 0;
                border-right: none;
                border-top: 1px solid var(--gray-200);
                transform: translateY(calc(100% - 80px));
                transition: transform 0.3s ease;
                border-radius: 20px 20px 0 0;
                overflow: hidden;
            }
            
            .sidebar.expanded {
                transform: translateY(0);
            }
            
            .hotel-card {
                flex-direction: column;
            }
            
            .hotel-image {
                width: 100%;
                height: 200px;
            }
            
            .save-btn {
                position: absolute;
                top: 16px;
                right: 16px;
                z-index: 10;
            }
            
            .map-container, .map-container.with-trip-bar {
                margin-bottom: 60px;
            }
            
            .sidebar::before {
                content: '';
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: var(--gray-300);
                border-radius: 2px;
            }
            
            .map-container {
                height: 100vh;
            }
            
            .filters-section {
                display: none;
            }
            
            .hotels-section {
                padding-top: 40px;
            }
        }
        
        /* Custom Marker Styles */
        .hotel-marker {
            background: var(--white);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            border: 3px solid var(--ocean-blue);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .hotel-marker:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }
        
        .hotel-marker.luxury {
            border-color: #fbbf24;
            background: #fef3c7;
        }
        
        .hotel-marker.selected {
            transform: scale(1.2);
            z-index: 1000 !important;
        }
        
        .marker-tooltip {
            background: var(--white);
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: var(--shadow);
            font-size: 14px;
            white-space: nowrap;
        }
        
        /* Trip Planning Styles */
        .trip-planning-bar {
            position: absolute;
            top: 70px;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to right, var(--ocean-light), var(--ocean-blue));
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 24px;
            z-index: 999;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }
        
        .trip-planning-bar.hidden {
            transform: translateY(-100%);
        }
        
        .trip-info {
            display: flex;
            align-items: center;
            gap: 16px;
            color: var(--white);
        }
        
        .trip-dates {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .trip-dates:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .trip-guests {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .trip-guests:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .trip-summary {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .saved-count {
            background: var(--white);
            color: var(--ocean-blue);
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .trip-actions {
            display: flex;
            gap: 12px;
        }
        
        .trip-btn {
            background: var(--white);
            color: var(--ocean-blue);
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .trip-btn:hover {
            background: var(--gray-50);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        
        .trip-btn.primary {
            background: var(--coral-accent);
            color: var(--white);
        }
        
        .trip-btn.primary:hover {
            background: #d62828;
        }
        
        /* Save Button */
        .save-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--white);
            border: 2px solid var(--gray-300);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 20px;
        }
        
        .save-btn:hover {
            border-color: var(--coral-accent);
            background: var(--gray-50);
            transform: scale(1.1);
        }
        
        .save-btn.saved {
            background: var(--coral-accent);
            border-color: var(--coral-accent);
            color: var(--white);
            animation: heartBeat 0.6s ease;
        }
        
        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.3); }
            50% { transform: scale(1.1); }
            75% { transform: scale(1.2); }
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2001;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-800);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-400);
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: var(--gray-600);
        }
        
        /* Comparison Panel */
        .comparison-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-top: 2px solid var(--ocean-blue);
            box-shadow: var(--shadow-xl);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 998;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .comparison-panel.active {
            transform: translateY(0);
        }
        
        .comparison-header {
            padding: 16px 24px;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            padding: 24px;
        }
        
        /* Distance Pills */
        .distance-info {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .distance-pill {
            background: var(--gray-100);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* With trip planning bar adjustment */
        .map-container.with-trip-bar {
            margin-top: 130px;
        }
        
        .sidebar.with-trip-bar {
            margin-top: 130px;
        }
    </style>
</head>
<body>
    <a href="#map" class="skip-link">Skip to main content</a>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">🌊</div>
                <span>Algarve Trip Planner</span>
            </div>
            
            <div class="search-container" style="position: relative;">
                <span class="search-icon">🔍</span>
                <input type="text" class="search-box" placeholder="Search hotels by name or location..." id="searchBox">
            </div>
            
            <div class="view-toggles">
                <button class="view-toggle active" data-view="explore">Explore</button>
                <button class="view-toggle" data-view="saved">Saved</button>
                <button class="view-toggle" data-view="compare">Compare</button>
                <button class="view-toggle" data-view="trip">My Trip</button>
            </div>
        </header>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="filters-section">
                <div class="filter-group">
                    <label class="filter-label">Minimum Rating</label>
                    <div class="rating-filter">
                        <input type="range" class="rating-slider" id="ratingSlider" min="1" max="5" value="1" step="0.5">
                        <div class="rating-display" id="ratingDisplay">1+ ⭐</div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Price Range</label>
                    <div class="price-filters">
                        <div class="price-filter" data-price="1">€</div>
                        <div class="price-filter" data-price="2">€€</div>
                        <div class="price-filter" data-price="3">€€€</div>
                        <div class="price-filter" data-price="4">€€€€</div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">Amenities</label>
                    <div class="amenities-grid">
                        <div class="amenity-filter" data-amenity="wifi">📶 WiFi</div>
                        <div class="amenity-filter" data-amenity="pool">🏊 Pool</div>
                        <div class="amenity-filter" data-amenity="parking">🚗 Parking</div>
                        <div class="amenity-filter" data-amenity="restaurant">🍽️ Restaurant</div>
                        <div class="amenity-filter" data-amenity="spa">💆 Spa</div>
                        <div class="amenity-filter" data-amenity="gym">🏋️ Gym</div>
                    </div>
                </div>
                
                <div class="filter-actions">
                    <button class="btn btn-primary" id="applyFilters">Apply Filters</button>
                    <button class="btn btn-secondary" id="clearFilters">Clear All</button>
                </div>
            </div>
            
            <div class="hotels-section">
                <div class="results-header">
                    <span class="results-count" id="resultsCount">Loading hotels...</span>
                    <select class="sort-dropdown" id="sortDropdown">
                        <option value="rating">Sort by Rating</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="name">Name A-Z</option>
                    </select>
                </div>
                
                <div id="hotelsList"></div>
            </div>
        </aside>
        
        <!-- Map -->
        <div class="map-container">
            <div id="map" role="main" aria-label="Hotel map of Algarve region"></div>
            <div class="map-controls">
                <button class="map-control" id="zoomIn" title="Zoom In">➕</button>
                <button class="map-control" id="zoomOut" title="Zoom Out">➖</button>
                <button class="map-control" id="locateMe" title="My Location">📍</button>
                <button class="map-control" id="fullscreen" title="Fullscreen">⛶</button>
            </div>
        </div>
    </div>
    
    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <button class="mobile-nav-item active" data-view="explore">
                <span class="mobile-nav-icon">🗺️</span>
                <span>Explore</span>
            </button>
            <button class="mobile-nav-item" data-view="saved">
                <span class="mobile-nav-icon">❤️</span>
                <span>Saved</span>
            </button>
            <button class="mobile-nav-item" data-view="compare">
                <span class="mobile-nav-icon">🔄</span>
                <span>Compare</span>
            </button>
            <button class="mobile-nav-item" data-view="trip">
                <span class="mobile-nav-icon">✈️</span>
                <span>My Trip</span>
            </button>
        </div>
    </nav>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Discovering the best hotels in Algarve...</p>
        </div>
    </div>
    
    <!-- Error Message -->
    <div class="error-message" id="errorMessage"></div>
    
    <!-- Date Picker Modal -->
    <div class="modal-overlay" id="dateModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Select Your Travel Dates</h2>
                <button class="modal-close" onclick="closeDateModal()">×</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-700);">Check-in Date</label>
                        <input type="date" id="checkInDate" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 8px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-700);">Check-out Date</label>
                        <input type="date" id="checkOutDate" style="width: 100%; padding: 10px; border: 2px solid var(--gray-300); border-radius: 8px;">
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveTripDates()">Save Dates</button>
            </div>
        </div>
    </div>
    
    <!-- Guest Selector Modal -->
    <div class="modal-overlay" id="guestModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Select Guests</h2>
                <button class="modal-close" onclick="closeGuestModal()">×</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-700);">Number of Guests</label>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <button onclick="updateGuests(-1)" style="width: 40px; height: 40px; border: 2px solid var(--gray-300); background: var(--white); border-radius: 8px; cursor: pointer; font-size: 20px;">−</button>
                        <span id="guestCount" style="font-size: 24px; font-weight: 600; min-width: 40px; text-align: center;">2</span>
                        <button onclick="updateGuests(1)" style="width: 40px; height: 40px; border: 2px solid var(--gray-300); background: var(--white); border-radius: 8px; cursor: pointer; font-size: 20px;">+</button>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveGuests()">Save Guests</button>
            </div>
        </div>
    </div>
    
    <!-- Comparison Panel -->
    <div class="comparison-panel" id="comparisonPanel">
        <div class="comparison-header">
            <h3 style="margin: 0; font-weight: 600; color: var(--gray-800);">Compare Hotels</h3>
            <button class="btn btn-secondary" onclick="closeComparison()">Close Comparison</button>
        </div>
        <div class="comparison-grid" id="comparisonGrid">
            <!-- Comparison cards will be inserted here -->
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script>
        // State Management
        const state = {
            hotels: [],
            filteredHotels: [],
            selectedHotel: null,
            savedHotels: new Set(),
            compareHotels: new Set(),
            tripDates: {
                checkIn: null,
                checkOut: null
            },
            guests: 2,
            filters: {
                rating: 1,
                priceRange: [],
                amenities: [],
                search: ''
            },
            map: null,
            markers: new Map(),
            markerCluster: null,
            currentView: 'explore'
        };
        
        // Load saved data from localStorage
        function loadSavedData() {
            const saved = localStorage.getItem('algarveTrip');
            if (saved) {
                const data = JSON.parse(saved);
                state.savedHotels = new Set(data.savedHotels || []);
                state.tripDates = data.tripDates || { checkIn: null, checkOut: null };
                state.guests = data.guests || 2;
                updateTripUI();
            }
        }
        
        // Save data to localStorage
        function saveToLocalStorage() {
            const data = {
                savedHotels: Array.from(state.savedHotels),
                tripDates: state.tripDates,
                guests: state.guests
            };
            localStorage.setItem('algarveTrip', JSON.stringify(data));
        }
        
        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Toggle save hotel
        window.toggleSaveHotel = function(hotelId) {
            if (state.savedHotels.has(hotelId)) {
                state.savedHotels.delete(hotelId);
            } else {
                state.savedHotels.add(hotelId);
            }
            saveToLocalStorage();
            updateTripUI();
            renderHotels();
        }
        
        // Update trip UI
        function updateTripUI() {
            // Update saved count
            const savedCount = document.getElementById('savedCount');
            savedCount.textContent = `${state.savedHotels.size} hotel${state.savedHotels.size !== 1 ? 's' : ''} saved`;
            
            // Update dates
            const datesText = document.getElementById('tripDatesText');
            if (state.tripDates.checkIn && state.tripDates.checkOut) {
                const checkIn = new Date(state.tripDates.checkIn).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const checkOut = new Date(state.tripDates.checkOut).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                datesText.textContent = `${checkIn} - ${checkOut}`;
            } else {
                datesText.textContent = 'Select dates';
            }
            
            // Update guests
            const guestsText = document.getElementById('tripGuestsText');
            guestsText.textContent = `${state.guests} guest${state.guests !== 1 ? 's' : ''}`;
        }
        
        // Initialize Map
        function initializeMap() {
            state.map = L.map('map', {
                center: [37.0611, -8.3033],
                zoom: 11,
                zoomControl: false
            });
            
            // Use a cleaner tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(state.map);
            
            // Initialize marker cluster group
            state.markerCluster = L.markerClusterGroup({
                maxClusterRadius: 50,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    return L.divIcon({
                        html: `<div class="hotel-marker" style="background: var(--ocean-light); color: white; font-size: 14px; font-weight: 600;">${count}</div>`,
                        className: 'marker-cluster',
                        iconSize: [40, 40]
                    });
                }
            });
            
            state.map.addLayer(state.markerCluster);
            
            // Add city markers
            addCityMarkers();
        }
        
        // Add city markers for Faro and Lagos
        function addCityMarkers() {
            const cityIcon = L.divIcon({
                html: '<div style="background: var(--deep-blue); color: white; padding: 8px 12px; border-radius: 20px; font-weight: 600; box-shadow: var(--shadow);">Faro</div>',
                className: 'city-marker',
                iconAnchor: [40, 20]
            });
            
            L.marker([37.0194, -7.9322], { icon: cityIcon })
                .addTo(state.map)
                .bindPopup('<b>Faro</b><br>Capital of the Algarve<br>Airport hub and historic city');
                
            const lagosIcon = L.divIcon({
                html: '<div style="background: var(--deep-blue); color: white; padding: 8px 12px; border-radius: 20px; font-weight: 600; box-shadow: var(--shadow);">Lagos</div>',
                className: 'city-marker',
                iconAnchor: [40, 20]
            });
                
            L.marker([37.1028, -8.6744], { icon: lagosIcon })
                .addTo(state.map)
                .bindPopup('<b>Lagos</b><br>Historic coastal city<br>Famous beaches and nightlife');
        }
        
        // Hotel Data Management
        async function fetchHotels() {
            const bounds = state.map.getBounds();
            const query = `
                [out:json][timeout:30];
                (
                    node["tourism"="hotel"]["name"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});
                    way["tourism"="hotel"]["name"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});
                    relation["tourism"="hotel"]["name"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});
                );
                out body;
                >;
                out skel qt;
            `;
            
            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: 'data=' + encodeURIComponent(query),
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch hotel data');
                
                const data = await response.json();
                return processHotelData(data.elements);
            } catch (error) {
                console.error('Error fetching hotels:', error);
                throw error;
            }
        }
        
        // Process and verify hotel data
        function processHotelData(elements) {
            const hotels = [];
            
            elements.forEach(element => {
                if (!element.tags?.name) return;
                
                const lat = element.lat || element.center?.lat;
                const lon = element.lon || element.center?.lon;
                
                if (!lat || !lon) return;
                
                // Verify hotel has sufficient data
                const dataPoints = [];
                if (element.tags.stars) dataPoints.push('stars');
                if (element.tags.phone) dataPoints.push('phone');
                if (element.tags.website) dataPoints.push('website');
                if (element.tags['addr:street']) dataPoints.push('address');
                if (element.tags.rooms) dataPoints.push('rooms');
                if (element.tags.email) dataPoints.push('email');
                if (element.tags.operator) dataPoints.push('operator');
                
                // Only include hotels with at least 2 data points beyond name
                if (dataPoints.length < 2) return;
                
                const hotel = {
                    id: element.id,
                    name: element.tags.name,
                    lat: lat,
                    lon: lon,
                    rating: element.tags.stars ? parseFloat(element.tags.stars) : null,
                    address: element.tags['addr:street'] || '',
                    city: element.tags['addr:city'] || '',
                    phone: element.tags.phone || '',
                    website: element.tags.website || '',
                    email: element.tags.email || '',
                    rooms: element.tags.rooms || '',
                    operator: element.tags.operator || '',
                    amenities: extractAmenities(element.tags),
                    priceCategory: estimatePriceCategory(element.tags),
                    qualityScore: dataPoints.length
                };
                
                hotels.push(hotel);
            });
            
            return hotels.sort((a, b) => b.qualityScore - a.qualityScore);
        }
        
        // Extract amenities from tags
        function extractAmenities(tags) {
            const amenities = [];
            
            if (tags.internet_access === 'yes' || tags.internet_access === 'wlan' || tags.wifi === 'yes') {
                amenities.push('wifi');
            }
            if (tags['swimming_pool'] === 'yes' || tags.amenity?.includes('swimming_pool')) {
                amenities.push('pool');
            }
            if (tags.parking === 'yes' || tags['parking:fee'] === 'no') {
                amenities.push('parking');
            }
            if (tags.restaurant === 'yes' || tags['amenity:restaurant'] === 'yes') {
                amenities.push('restaurant');
            }
            if (tags.spa === 'yes' || tags['leisure'] === 'spa') {
                amenities.push('spa');
            }
            if (tags.fitness_centre === 'yes' || tags.gym === 'yes') {
                amenities.push('gym');
            }
            
            return amenities;
        }
        
        // Estimate price category based on stars and amenities
        function estimatePriceCategory(tags) {
            const stars = tags.stars ? parseFloat(tags.stars) : 0;
            
            if (stars >= 4.5) return 4;
            if (stars >= 3.5) return 3;
            if (stars >= 2.5) return 2;
            return 1;
        }
        
        // Create hotel marker
        function createHotelMarker(hotel) {
            const isLuxury = hotel.rating >= 4;
            const markerClass = isLuxury ? 'hotel-marker luxury' : 'hotel-marker';
            
            const icon = L.divIcon({
                html: `<div class="${markerClass}">🏨</div>`,
                className: 'custom-marker',
                iconSize: [36, 36],
                iconAnchor: [18, 18]
            });
            
            const marker = L.marker([hotel.lat, hotel.lon], { icon });
            
            // Create popup content
            const popupContent = createPopupContent(hotel);
            marker.bindPopup(popupContent, {
                maxWidth: 300,
                className: 'hotel-popup'
            });
            
            // Add hover tooltip
            marker.bindTooltip(hotel.name, {
                permanent: false,
                direction: 'top',
                className: 'marker-tooltip'
            });
            
            // Handle marker click
            marker.on('click', () => selectHotel(hotel));
            
            return marker;
        }
        
        // Create popup content
        function createPopupContent(hotel) {
            let content = '<div class="hotel-popup-content">';
            content += `<h3 style="margin: 0 0 8px 0; color: var(--gray-800);">${hotel.name}</h3>`;
            
            if (hotel.rating) {
                content += `<div style="color: #fbbf24; margin-bottom: 8px;">${'⭐'.repeat(Math.floor(hotel.rating))} ${hotel.rating}</div>`;
            }
            
            if (hotel.address || hotel.city) {
                content += `<p style="margin: 4px 0; font-size: 14px; color: var(--gray-600);">📍 ${hotel.address} ${hotel.city}</p>`;
            }
            
            if (hotel.phone) {
                content += `<p style="margin: 4px 0; font-size: 14px; color: var(--gray-600);">📞 ${hotel.phone}</p>`;
            }
            
            if (hotel.website) {
                content += `<p style="margin: 4px 0; font-size: 14px;"><a href="${hotel.website}" target="_blank" style="color: var(--ocean-blue);">🌐 Visit Website</a></p>`;
            }
            
            if (hotel.amenities.length > 0) {
                content += '<div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">';
                hotel.amenities.forEach(amenity => {
                    const amenityIcons = {
                        wifi: '📶',
                        pool: '🏊',
                        parking: '🚗',
                        restaurant: '🍽️',
                        spa: '💆',
                        gym: '🏋️'
                    };
                    content += `<span style="font-size: 16px;" title="${amenity}">${amenityIcons[amenity] || amenity}</span>`;
                });
                content += '</div>';
            }
            
            content += '</div>';
            return content;
        }
        
        // Render hotels in sidebar
        function renderHotels() {
            const hotelsList = document.getElementById('hotelsList');
            const resultsCount = document.getElementById('resultsCount');
            
            hotelsList.innerHTML = '';
            
            if (state.filteredHotels.length === 0) {
                hotelsList.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 40px;">No hotels found matching your criteria.</p>';
                resultsCount.textContent = 'No results';
                return;
            }
            
            resultsCount.textContent = `${state.filteredHotels.length} hotels found`;
            
            state.filteredHotels.forEach(hotel => {
                const card = createHotelCard(hotel);
                hotelsList.appendChild(card);
            });
        }
        
        // Create hotel card element
        function createHotelCard(hotel) {
            const card = document.createElement('div');
            card.className = 'hotel-card';
            if (state.selectedHotel?.id === hotel.id) {
                card.classList.add('selected');
            }
            
            const priceSymbols = '€'.repeat(hotel.priceCategory);
            const ratingStars = hotel.rating ? '⭐'.repeat(Math.floor(hotel.rating)) : '';
            
            card.innerHTML = `
                <button class="save-btn ${state.savedHotels && state.savedHotels.has(hotel.id) ? 'saved' : ''}" onclick="window.toggleSaveHotel(${hotel.id})" title="Save to trip">
                    ${state.savedHotels && state.savedHotels.has(hotel.id) ? '❤️' : '🤍'}
                </button>
                <div class="hotel-image">🏨</div>
                <div class="hotel-info">
                    <div class="hotel-header">
                        <div>
                            <div class="hotel-name">${hotel.name}</div>
                            ${hotel.rating ? `<div class="hotel-rating"><span class="stars">${ratingStars}</span> ${hotel.rating}</div>` : ''}
                        </div>
                        <div>
                            <div class="hotel-price">${priceSymbols}</div>
                            <div style="font-size: 14px; color: var(--gray-600);">€${estimatePricePerNight(hotel)}/night</div>
                        </div>
                    </div>
                    <div class="hotel-details">
                        ${hotel.address || hotel.city ? `<div>📍 ${hotel.address} ${hotel.city}</div>` : ''}
                        ${hotel.rooms ? `<div>🛏️ ${hotel.rooms} rooms</div>` : ''}
                        <div class="distance-info">
                            <span class="distance-pill">✈️ ${calculateDistance(hotel.lat, hotel.lon, 37.0194, -7.9322).toFixed(1)} km to Faro Airport</span>
                            <span class="distance-pill">🏖️ ${calculateDistance(hotel.lat, hotel.lon, 37.0179, -7.9304).toFixed(1)} km to beach</span>
                        </div>
                    </div>
                    ${hotel.amenities.length > 0 ? `
                        <div class="hotel-amenities">
                            ${hotel.amenities.map(a => {
                                const icons = { wifi: '📶 WiFi', pool: '🏊 Pool', parking: '🚗 Parking', restaurant: '🍽️ Restaurant', spa: '💆 Spa', gym: '🏋️ Gym' };
                                return `<div class="amenity">${icons[a] || a}</div>`;
                            }).join('')}
                        </div>
                    ` : ''}
                    <div class="hotel-actions">
                        ${hotel.phone ? `<button class="hotel-action" onclick="window.open('tel:${hotel.phone}', '_blank')">📞 Call</button>` : ''}
                        ${hotel.website ? `<button class="hotel-action" onclick="window.open('${hotel.website}', '_blank')">🌐 Website</button>` : ''}
                        <button class="hotel-action" onclick="getDirections(${hotel.lat}, ${hotel.lon})">🧭 Directions</button>
                    </div>
                </div>
            `;
            
            card.addEventListener('click', () => selectHotel(hotel));
            
            return card;
        }
        
        // Select hotel
        function selectHotel(hotel) {
            state.selectedHotel = hotel;
            
            // Update UI
            document.querySelectorAll('.hotel-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Center map on hotel
            state.map.setView([hotel.lat, hotel.lon], 16);
            
            // Open marker popup
            const marker = state.markers.get(hotel.id);
            if (marker) {
                marker.openPopup();
            }
            
            // Update card selection
            renderHotels();
        }
        
        // Get directions
        function getDirections(lat, lon) {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
            window.open(url, '_blank');
        }
        
        // Filter hotels
        function filterHotels() {
            state.filteredHotels = state.hotels.filter(hotel => {
                // Rating filter
                if (hotel.rating && hotel.rating < state.filters.rating) {
                    return false;
                }
                
                // Price filter
                if (state.filters.priceRange.length > 0 && !state.filters.priceRange.includes(hotel.priceCategory)) {
                    return false;
                }
                
                // Amenities filter
                if (state.filters.amenities.length > 0) {
                    const hasAllAmenities = state.filters.amenities.every(amenity => 
                        hotel.amenities.includes(amenity)
                    );
                    if (!hasAllAmenities) return false;
                }
                
                // Search filter
                if (state.filters.search) {
                    const searchLower = state.filters.search.toLowerCase();
                    const nameMatch = hotel.name.toLowerCase().includes(searchLower);
                    const cityMatch = hotel.city.toLowerCase().includes(searchLower);
                    const addressMatch = hotel.address.toLowerCase().includes(searchLower);
                    
                    if (!nameMatch && !cityMatch && !addressMatch) return false;
                }
                
                return true;
            });
            
            // Sort hotels
            const sortBy = document.getElementById('sortDropdown').value;
            switch (sortBy) {
                case 'rating':
                    state.filteredHotels.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                    break;
                case 'price-low':
                    state.filteredHotels.sort((a, b) => a.priceCategory - b.priceCategory);
                    break;
                case 'price-high':
                    state.filteredHotels.sort((a, b) => b.priceCategory - a.priceCategory);
                    break;
                case 'name':
                    state.filteredHotels.sort((a, b) => a.name.localeCompare(b.name));
                    break;
            }
            
            updateMarkers();
            renderHotels();
        }
        
        // Update map markers
        function updateMarkers() {
            // Clear existing markers
            state.markerCluster.clearLayers();
            state.markers.clear();
            
            // Add filtered hotel markers
            state.filteredHotels.forEach(hotel => {
                const marker = createHotelMarker(hotel);
                state.markers.set(hotel.id, marker);
                state.markerCluster.addLayer(marker);
            });
        }
        
        // Initialize filters
        function initializeFilters() {
            // Rating slider
            const ratingSlider = document.getElementById('ratingSlider');
            const ratingDisplay = document.getElementById('ratingDisplay');
            
            ratingSlider.addEventListener('input', (e) => {
                const value = parseFloat(e.target.value);
                state.filters.rating = value;
                ratingDisplay.textContent = `${value}+ ⭐`;
            });
            
            // Price filters
            document.querySelectorAll('.price-filter').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('active');
                    const price = parseInt(btn.dataset.price);
                    
                    if (btn.classList.contains('active')) {
                        if (!state.filters.priceRange.includes(price)) {
                            state.filters.priceRange.push(price);
                        }
                    } else {
                        state.filters.priceRange = state.filters.priceRange.filter(p => p !== price);
                    }
                });
            });
            
            // Amenity filters
            document.querySelectorAll('.amenity-filter').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('active');
                    const amenity = btn.dataset.amenity;
                    
                    if (btn.classList.contains('active')) {
                        if (!state.filters.amenities.includes(amenity)) {
                            state.filters.amenities.push(amenity);
                        }
                    } else {
                        state.filters.amenities = state.filters.amenities.filter(a => a !== amenity);
                    }
                });
            });
            
            // Apply filters button
            document.getElementById('applyFilters').addEventListener('click', filterHotels);
            
            // Clear filters button
            document.getElementById('clearFilters').addEventListener('click', () => {
                state.filters = {
                    rating: 1,
                    priceRange: [],
                    amenities: [],
                    search: ''
                };
                
                // Reset UI
                document.getElementById('ratingSlider').value = 1;
                document.getElementById('ratingDisplay').textContent = '1+ ⭐';
                document.querySelectorAll('.price-filter, .amenity-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('searchBox').value = '';
                
                filterHotels();
            });
            
            // Search box
            const searchBox = document.getElementById('searchBox');
            let searchTimeout;
            
            searchBox.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    state.filters.search = e.target.value;
                    filterHotels();
                }, 300);
            });
            
            // Sort dropdown
            document.getElementById('sortDropdown').addEventListener('change', filterHotels);
        }
        
        // Initialize map controls
        function initializeMapControls() {
            document.getElementById('zoomIn').addEventListener('click', () => {
                state.map.zoomIn();
            });
            
            document.getElementById('zoomOut').addEventListener('click', () => {
                state.map.zoomOut();
            });
            
            document.getElementById('locateMe').addEventListener('click', () => {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            state.map.setView([latitude, longitude], 14);
                            
                            L.marker([latitude, longitude], {
                                icon: L.divIcon({
                                    html: '<div style="background: var(--ocean-blue); color: white; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: var(--shadow);"></div>',
                                    className: 'location-marker',
                                    iconSize: [22, 22]
                                })
                            }).addTo(state.map)
                            .bindPopup('You are here');
                        },
                        (error) => {
                            showError('Unable to get your location');
                        }
                    );
                } else {
                    showError('Geolocation is not supported by your browser');
                }
            });
            
            document.getElementById('fullscreen').addEventListener('click', () => {
                const mapContainer = document.querySelector('.map-container');
                if (!document.fullscreenElement) {
                    mapContainer.requestFullscreen();
                } else {
                    document.exitFullscreen();
                }
            });
        }
        
        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        // Mobile sidebar handling
        function initializeMobileSidebar() {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                let startY = 0;
                let currentY = 0;
                let isDragging = false;
                
                sidebar.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                    isDragging = true;
                });
                
                sidebar.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    
                    currentY = e.touches[0].clientY;
                    const diff = startY - currentY;
                    
                    if (diff > 50) {
                        sidebar.classList.add('expanded');
                    } else if (diff < -50) {
                        sidebar.classList.remove('expanded');
                    }
                });
                
                sidebar.addEventListener('touchend', () => {
                    isDragging = false;
                });
            }
        }
        
        // Date modal functions
        function openDateModal() {
            document.getElementById('dateModal').classList.add('active');
            if (state.tripDates.checkIn) {
                document.getElementById('checkInDate').value = state.tripDates.checkIn;
            }
            if (state.tripDates.checkOut) {
                document.getElementById('checkOutDate').value = state.tripDates.checkOut;
            }
        }
        
        window.closeDateModal = function() {
            document.getElementById('dateModal').classList.remove('active');
        }
        
        window.saveTripDates = function() {
            const checkIn = document.getElementById('checkInDate').value;
            const checkOut = document.getElementById('checkOutDate').value;
            
            if (checkIn && checkOut && checkIn < checkOut) {
                state.tripDates.checkIn = checkIn;
                state.tripDates.checkOut = checkOut;
                saveToLocalStorage();
                updateTripUI();
                closeDateModal();
                
                // Calculate estimated prices
                updateHotelPrices();
            } else {
                showError('Please select valid check-in and check-out dates');
            }
        }
        
        // Guest modal functions
        function openGuestModal() {
            document.getElementById('guestModal').classList.add('active');
            document.getElementById('guestCount').textContent = state.guests;
        }
        
        window.closeGuestModal = function() {
            document.getElementById('guestModal').classList.remove('active');
        }
        
        window.updateGuests = function(change) {
            const newCount = state.guests + change;
            if (newCount >= 1 && newCount <= 10) {
                state.guests = newCount;
                document.getElementById('guestCount').textContent = newCount;
            }
        }
        
        window.saveGuests = function() {
            saveToLocalStorage();
            updateTripUI();
            closeGuestModal();
        }
        
        // Comparison functions
        function toggleCompare(hotelId) {
            if (state.compareHotels.has(hotelId)) {
                state.compareHotels.delete(hotelId);
            } else if (state.compareHotels.size < 3) {
                state.compareHotels.add(hotelId);
            } else {
                showError('You can compare up to 3 hotels at a time');
                return;
            }
            
            if (state.compareHotels.size > 0) {
                showComparison();
            } else {
                closeComparison();
            }
        }
        
        function showComparison() {
            const panel = document.getElementById('comparisonPanel');
            panel.classList.add('active');
            
            const grid = document.getElementById('comparisonGrid');
            grid.innerHTML = '';
            
            state.compareHotels.forEach(hotelId => {
                const hotel = state.hotels.find(h => h.id === hotelId);
                if (hotel) {
                    const card = createComparisonCard(hotel);
                    grid.appendChild(card);
                }
            });
        }
        
        window.closeComparison = function() {
            document.getElementById('comparisonPanel').classList.remove('active');
            state.compareHotels.clear();
        }
        
        function createComparisonCard(hotel) {
            const card = document.createElement('div');
            card.style.cssText = 'background: var(--white); border-radius: 12px; padding: 20px; box-shadow: var(--shadow);';
            
            const pricePerNight = estimatePricePerNight(hotel);
            const nights = calculateNights();
            const totalPrice = pricePerNight * nights;
            
            card.innerHTML = `
                <h3 style="margin: 0 0 16px 0; color: var(--gray-800);">${hotel.name}</h3>
                ${hotel.rating ? `<div style="color: #fbbf24; margin-bottom: 12px;">${'⭐'.repeat(Math.floor(hotel.rating))} ${hotel.rating}</div>` : ''}
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--ocean-blue);">€${pricePerNight}/night</div>
                    ${nights > 0 ? `<div style="color: var(--gray-600);">€${totalPrice} total for ${nights} nights</div>` : ''}
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px; font-size: 14px; color: var(--gray-600);">
                    <div>✈️ ${calculateDistance(hotel.lat, hotel.lon, 37.0194, -7.9322).toFixed(1)} km to Faro Airport</div>
                    <div>🏖️ ${calculateDistance(hotel.lat, hotel.lon, 37.0179, -7.9304).toFixed(1)} km to beach</div>
                    ${hotel.amenities.length > 0 ? `<div>✨ ${hotel.amenities.map(a => a.charAt(0).toUpperCase() + a.slice(1)).join(', ')}</div>` : ''}
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="selectHotel(${hotel.id})">View Details</button>
            `;
            
            return card;
        }
        
        // Price estimation
        function estimatePricePerNight(hotel) {
            const basePrice = hotel.priceCategory * 50;
            const starMultiplier = hotel.rating ? hotel.rating * 1.2 : 1;
            return Math.round(basePrice * starMultiplier);
        }
        
        function calculateNights() {
            if (state.tripDates.checkIn && state.tripDates.checkOut) {
                const checkIn = new Date(state.tripDates.checkIn);
                const checkOut = new Date(state.tripDates.checkOut);
                return Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
            }
            return 0;
        }
        
        function updateHotelPrices() {
            renderHotels();
        }
        
        // View management
        function switchView(view) {
            state.currentView = view;
            document.querySelectorAll('.view-toggle').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            
            if (view === 'saved') {
                showSavedHotels();
            } else if (view === 'compare') {
                if (state.compareHotels.size > 0) {
                    showComparison();
                } else {
                    showError('Select hotels to compare first');
                }
            } else if (view === 'trip') {
                showTripSummary();
            } else {
                // Show regular explore view
                renderHotels();
            }
        }
        
        function showSavedHotels() {
            state.filteredHotels = state.hotels.filter(hotel => state.savedHotels.has(hotel.id));
            renderHotels();
            updateMarkers();
        }
        
        function showTripSummary() {
            const hotelsList = document.getElementById('hotelsList');
            
            if (state.savedHotels.size === 0) {
                hotelsList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">🦭</div>
                        <h3 style="color: var(--gray-800); margin-bottom: 8px;">No hotels saved yet</h3>
                        <p style="color: var(--gray-600);">Start exploring and save hotels to build your perfect trip!</p>
                        <button class="btn btn-primary" style="margin-top: 16px;" onclick="switchView('explore')">Explore Hotels</button>
                    </div>
                `;
                return;
            }
            
            const savedHotels = state.hotels.filter(h => state.savedHotels.has(h.id));
            const nights = calculateNights();
            let totalCost = 0;
            
            savedHotels.forEach(hotel => {
                totalCost += estimatePricePerNight(hotel) * nights;
            });
            
            hotelsList.innerHTML = `
                <div style="background: linear-gradient(to right, var(--ocean-light), var(--ocean-blue)); color: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
                    <h2 style="margin: 0 0 16px 0;">Your Algarve Trip</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <div style="opacity: 0.8; font-size: 14px;">Dates</div>
                            <div style="font-size: 18px; font-weight: 600;">${state.tripDates.checkIn && state.tripDates.checkOut ? `${new Date(state.tripDates.checkIn).toLocaleDateString()} - ${new Date(state.tripDates.checkOut).toLocaleDateString()}` : 'Not selected'}</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; font-size: 14px;">Guests</div>
                            <div style="font-size: 18px; font-weight: 600;">${state.guests} guest${state.guests !== 1 ? 's' : ''}</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; font-size: 14px;">Hotels</div>
                            <div style="font-size: 18px; font-weight: 600;">${savedHotels.length} saved</div>
                        </div>
                        <div>
                            <div style="opacity: 0.8; font-size: 14px;">Estimated Cost</div>
                            <div style="font-size: 18px; font-weight: 600;">€${totalCost}</div>
                        </div>
                    </div>
                </div>
            `;
            
            savedHotels.forEach(hotel => {
                const card = createHotelCard(hotel);
                hotelsList.appendChild(card);
            });
        }
        
        // Share trip functionality
        function shareTrip() {
            const tripData = {
                hotels: Array.from(state.savedHotels),
                dates: state.tripDates,
                guests: state.guests
            };
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?trip=${btoa(JSON.stringify(tripData))}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Algarve Trip',
                    text: `Check out my planned trip to Algarve with ${state.savedHotels.size} hotels!`,
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showError('Trip link copied to clipboard!');
                });
            }
        }
        
        // Initialize app
        async function initializeApp() {
            try {
                initializeMap();
                initializeFilters();
                initializeMapControls();
                initializeMobileSidebar();
                initializeTripPlanning();
                loadSavedData();
                
                // Check for shared trip in URL
                const urlParams = new URLSearchParams(window.location.search);
                const sharedTrip = urlParams.get('trip');
                if (sharedTrip) {
                    try {
                        const tripData = JSON.parse(atob(sharedTrip));
                        state.savedHotels = new Set(tripData.hotels || []);
                        state.tripDates = tripData.dates || { checkIn: null, checkOut: null };
                        state.guests = tripData.guests || 2;
                        saveToLocalStorage();
                        updateTripUI();
                        showError('Trip loaded successfully!');
                    } catch (e) {
                        console.error('Failed to load shared trip', e);
                    }
                }
                
                const hotels = await fetchHotels();
                state.hotels = hotels;
                state.filteredHotels = hotels;
                
                updateMarkers();
                renderHotels();
                
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                showError('Failed to load hotels. Please refresh the page to try again.');
            }
        }
        
        // Start the app
        initializeApp();
        
        // Initialize trip planning UI
        function initializeTripPlanning() {
            // Date picker click handler
            document.getElementById('tripDates').addEventListener('click', openDateModal);
            
            // Guest selector click handler
            document.getElementById('tripGuests').addEventListener('click', openGuestModal);
            
            // View saved button
            document.getElementById('viewSavedBtn').addEventListener('click', () => {
                switchView('saved');
            });
            
            // Share trip button
            document.getElementById('shareTripBtn').addEventListener('click', shareTrip);
            
            // View toggle handlers
            document.querySelectorAll('.view-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    switchView(btn.dataset.view);
                });
            });
            
            // Set min date for date pickers to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('checkInDate').min = today;
            document.getElementById('checkOutDate').min = today;
            
            // Mobile navigation handlers
            document.querySelectorAll('.mobile-nav-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.mobile-nav-item').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    switchView(btn.dataset.view);
                });
            });
        }
        
        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            // Escape key closes modals
            if (e.key === 'Escape') {
                closeDateModal();
                closeGuestModal();
                closeComparison();
            }
            
            // Tab navigation for hotel cards
            if (e.key === 'Tab') {
                const focusableElements = document.querySelectorAll(
                    'button, input, select, textarea, a[href], [tabindex]:not([tabindex="-1"])'
                );
                const focusedIndex = Array.from(focusableElements).indexOf(document.activeElement);
                
                if (e.shiftKey && focusedIndex === 0) {
                    e.preventDefault();
                    focusableElements[focusableElements.length - 1].focus();
                } else if (!e.shiftKey && focusedIndex === focusableElements.length - 1) {
                    e.preventDefault();
                    focusableElements[0].focus();
                }
            }
            
            // Arrow key navigation for view toggles
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                const toggles = Array.from(document.querySelectorAll('.view-toggle'));
                const activeIndex = toggles.findIndex(t => t.classList.contains('active'));
                
                if (activeIndex !== -1) {
                    let newIndex = activeIndex;
                    if (e.key === 'ArrowLeft') {
                        newIndex = activeIndex > 0 ? activeIndex - 1 : toggles.length - 1;
                    } else {
                        newIndex = activeIndex < toggles.length - 1 ? activeIndex + 1 : 0;
                    }
                    
                    toggles[newIndex].click();
                    toggles[newIndex].focus();
                }
            }
        });
        
        // Accessibility announcements
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('role', 'status');
            announcement.setAttribute('aria-live', 'polite');
            announcement.style.position = 'absolute';
            announcement.style.left = '-10000px';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }
        
        // Update save/unsave with announcements
        const originalToggleSave = window.toggleSaveHotel;
        window.toggleSaveHotel = function(hotelId) {
            const wasSaved = state.savedHotels.has(hotelId);
            originalToggleSave(hotelId);
            
            const hotel = state.hotels.find(h => h.id === hotelId);
            if (hotel) {
                const message = wasSaved ? 
                    `${hotel.name} removed from trip` : 
                    `${hotel.name} saved to trip`;
                announceToScreenReader(message);
            }
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (state.map) {
                state.map.invalidateSize();
            }
        });
    </script>
</body>
</html>